<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exam Mode</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      color: #333;
      margin: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .dark-mode {
      background: #1e1e1e;
      color: #ddd;
    }
    h1 {
      margin-bottom: 1rem;
    }
    .setup, .question-box, .result-box {
      margin-bottom: 2rem;
      max-width: 600px;
      text-align: center;
    }
    select, input[type="number"], button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin: 0.5rem;
    }
    button {
      background-color: #333;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .dark-mode button {
      background-color: #555;
    }
    .choices {
      margin-top: 1rem;
      text-align: left;
    }
    .choices button {
      display: block;
      margin: 0.5rem 0;
      width: 100%;
      background-color: #fff;
      color: #333;
    }
    .dark-mode .choices button {
      background-color: #333;
      color: #fff;
    }
    .highlight {
      background-color: #cce5ff;
    }
    .correct {
      background-color: #d4edda !important;
    }
    .incorrect {
      background-color: #f8d7da !important;
    }
  </style>
</head>
<body>
  <h1>Exam Mode</h1>

  <div class="setup">
    <label>Competency: 
      <select id="compSelect">
        <option value="c1.json">Competency 1</option>
        <option value="c2.json">Competency 2</option>
      </select>
    </label><br>
    <label>Mode:
      <select id="modeSelect">
        <option value="tos">MARINA TOS</option>
        <option value="custom">Choose number</option>
      </select>
    </label><br>
    <label id="customCountContainer" style="display:none;">
      Number of Questions: <input type="number" id="questionCount" min="1" max="100">
    </label><br>
    <button id="startExam">Start Exam</button>
    <button id="toggleDark">Toggle Dark Mode</button>
  </div>

  <div class="question-box" style="display:none">
    <div id="questionText"></div>
    <div class="choices" id="choices"></div>
    <button id="submitAnswer">Submit</button>
  </div>

  <div class="result-box" style="display:none">
    <h2>Exam Completed</h2>
    <p id="scoreDisplay"></p>
    <div id="reviewAnswers"></div>
  </div>

  <script>
    const compSelect = document.getElementById("compSelect");
    const modeSelect = document.getElementById("modeSelect");
    const countInput = document.getElementById("questionCount");
    const customCountContainer = document.getElementById("customCountContainer");
    const startBtn = document.getElementById("startExam");
    const toggleDark = document.getElementById("toggleDark");
    const questionBox = document.querySelector(".question-box");
    const resultBox = document.querySelector(".result-box");
    const questionText = document.getElementById("questionText");
    const choicesDiv = document.getElementById("choices");
    const submitBtn = document.getElementById("submitAnswer");
    const scoreDisplay = document.getElementById("scoreDisplay");
    const reviewAnswers = document.getElementById("reviewAnswers");

    let questions = [];
    let currentQuestion = 0;
    let score = 0;
    let userAnswers = [];

    modeSelect.addEventListener("change", () => {
      customCountContainer.style.display = modeSelect.value === "custom" ? "inline-block" : "none";
    });

    toggleDark.onclick = () => {
      document.body.classList.toggle("dark-mode");
    };

    startBtn.onclick = () => {
      const comp = compSelect.value;
      fetch(comp)
        .then(res => res.json())
        .then(data => {
          let count = 0;
          if (modeSelect.value === "tos") {
            count = comp === "c1.json" ? 35 : 20;
          } else {
            const requested = parseInt(countInput.value);
            count = Math.min(requested, data.length);
          }
          questions = shuffleArray(data).slice(0, count);
          questions = questions.map(q => ({
            ...q,
            allChoices: shuffleArray([q.answer, ...getRandomWrongAnswers(data, q.answer, 3)])
          }));
          currentQuestion = 0;
          score = 0;
          userAnswers = [];
          document.querySelector(".setup").style.display = "none";
          questionBox.style.display = "block";
          resultBox.style.display = "none";
          renderQuestion();
        });
    };

    function renderQuestion() {
      const q = questions[currentQuestion];
      questionText.textContent = `Q${currentQuestion + 1}: ${q.question}`;
      choicesDiv.innerHTML = "";
      q.allChoices.forEach(choice => {
        const btn = document.createElement("button");
        btn.textContent = choice;
        btn.onclick = () => {
          document.querySelectorAll("#choices button").forEach(b => b.classList.remove("highlight"));
          btn.classList.add("highlight");
          userAnswers[currentQuestion] = choice;
        };
        choicesDiv.appendChild(btn);
      });
    }

    submitBtn.onclick = () => {
      const userAnswer = userAnswers[currentQuestion];
      if (!userAnswer) return alert("Please select an answer.");

      const correct = questions[currentQuestion].answer;
      const buttons = document.querySelectorAll("#choices button");
      buttons.forEach(btn => {
        if (btn.textContent === correct) btn.classList.add("correct");
        if (btn.textContent === userAnswer && userAnswer !== correct) btn.classList.add("incorrect");
        btn.disabled = true;
      });

      if (userAnswer === correct) score++;

      setTimeout(() => {
        currentQuestion++;
        if (currentQuestion < questions.length) {
          renderQuestion();
        } else {
          endExam();
        }
      }, 1200);
    };

    function endExam() {
      questionBox.style.display = "none";
      resultBox.style.display = "block";
      const percent = ((score / questions.length) * 100).toFixed(2);
      scoreDisplay.textContent = `Score: ${score}/${questions.length} (${percent}%)`;
      reviewAnswers.innerHTML = questions.map((q, i) => `
        <div>
          <strong>Q${i+1}:</strong> ${q.question}<br>
          <strong>Your Answer:</strong> ${userAnswers[i]}<br>
          <strong>Correct Answer:</strong> ${q.answer}<hr>
        </div>
      `).join("");
    }

    function shuffleArray(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    function getRandomWrongAnswers(data, correct, count) {
      const wrongs = data.map(q => q.answer).filter(a => a !== correct);
      return shuffleArray(wrongs).slice(0, count);
    }
  </script>
</body>
</html>
